pipeline {
    agent any

    environment {
        GIT_REPO = 'https://github.com/DugnCon/BackEnd-CampusLearningUser.git'
        PROJECT_DIR = '/home/nguyenducduong/campuslearning/BackEnd-CampusLearningUser'
        DOCKER_COMPOSE_FILE = 'docker-compose.yml'
    }

    stages {
        stage('Pull latest code') {
            steps {
                echo "Pulling latest code from GitHub..."
                dir("${PROJECT_DIR}") {
                    sh 'git pull origin main'
                }
            }
        }

        stage('Build Spring Boot project') {
            steps {
                echo "Building Spring Boot application..."
                dir("${PROJECT_DIR}") {
                    sh 'mvn clean package -DskipTests'
                }
            }
        }

        stage('Deploy using Docker Compose') {
            steps {
                echo "Redeploying containers with Docker Compose..."
                dir("${PROJECT_DIR}") {
                    sh """
                        docker-compose down
                        docker-compose up -d --build
                    """
                }
            }
        }
    }

    post {
        success {
            echo "Deployment completed successfully!"
        }
        failure {
            echo "Deployment failed. Please check Jenkins logs."
        }
    }
}
